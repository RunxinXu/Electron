<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
    <link rel="stylesheet" href="assets/css/style.css">
    <title>Dashboard</title>
</head>

<body>
<div class="dashboard">


    <div class="login__row">
        <!-- <svg class="login__icon username svg-icon" viewBox="0 0 20 20">
            <path d="M0,20 a10,8 0 0,1 20,0z M10,0 a4,4 0 0,1 0,8 a4,4 0 0,1 0,-8"/>
        </svg> -->
        <span class="des">Source Language</span>
        <input id='src_lang' type="text" class="login__input username" placeholder="source language"/>
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="src_lang" value="target" /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="src_lang" value="condition" checked/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="src_lang" value="none"/> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <!-- <svg class="login__icon username svg-icon" viewBox="0 0 20 20">
            <path d="M0,20 a10,8 0 0,1 20,0z M10,0 a4,4 0 0,1 0,8 a4,4 0 0,1 0,-8"/>
        </svg> -->
        <span class="des">Target Language</span>
        <input id='trg_lang' type="text" class="login__input username" placeholder="target language"/>
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="trg_lang"  value="target"/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="trg_lang" value="condition" checked /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="trg_lang" value="none"/> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <!-- <svg class="login__icon pass svg-icon" viewBox="0 0 20 20">
            <path d="M0,20 20,20 20,8 0,8z M10,13 10,16z M4,8 a6,8 0 0,1 12,0"/>
        </svg> -->
        <span class="des">&nbsp;&nbsp;&nbsp;Date From&nbsp;&nbsp;&nbsp;</span>
        <input id="date_from" type="date" class="login__input username" />
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="date_from" value="target" /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="date_from" value="condition" checked/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="date_from" value="none"/> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <!-- <svg class="login__icon pass svg-icon" viewBox="0 0 20 20">
            <path d="M0,20 20,20 20,8 0,8z M10,13 10,16z M4,8 a6,8 0 0,1 12,0"/>
        </svg> -->
        <span class="des">&nbsp;&nbsp;&nbsp;&nbsp;Date To&nbsp;&nbsp;&nbsp;&nbsp;</span>
        <input id="date_to" type="date" class="login__input username" />
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="date_to" value="target" /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="date_to" value="condition" checked/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="date_to" value="none"/> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <span class="des">&nbsp;&nbsp;&nbsp;Uploader&nbsp;&nbsp;&nbsp;&nbsp;</span>
        <input id='uploader' type="text" class="login__input username" placeholder="Tom"/>
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="uploader" value="target" /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="uploader" value="condition"/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="uploader" value="none" checked/> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <span class="des">&nbsp;&nbsp;Source Text&nbsp;&nbsp;</span>
        <input id='src_text' type="text" class="login__input username" />
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="src_text"  value="target" checked/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="src_text" value="condition"/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="src_text" value="none" /> <span class="des">&nbsp;&nbsp;</span>
    </div>
    <div class="login__row">
        <span class="des">&nbsp;&nbsp;Target Text&nbsp;&nbsp;</span>
        <input id='trg_text' type="text" class="login__input username" />
        <span class="des">Target &nbsp;&nbsp;</span> <input type="radio" name="trg_text" value="target" checked/> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">Condition&nbsp;&nbsp;</span><input type="radio" name="trg_text" value="condition" /> <span class="des">&nbsp;&nbsp;</span>
        <span class="des">None&nbsp;&nbsp;</span> <input type="radio" name="trg_text" value="none"/> <span class="des">&nbsp;&nbsp;</span>
    </div>

    <input type="button" class="show__users" id="action-btn" value="Implement"/>
    <table id="table" width="400">
        <thead></thead>
        <tfoot></tfoot>
        <tbody></tbody>
    </table>

    <input id="export" type="button" style="display: none" class="show__users" value="Export" onclick="Export()">


    <button class="app__logout" title="Logout" onclick="window.location.href='index.html'">
        <svg class="app__logout-icon svg-icon" viewBox="0 0 20 20">
            <path d="M6,3 a8,8 0 1,0 8,0 M10,0 10,12"/>
        </svg>
    </button>
    <!-- <button class="register" title="Register" onclick="window.location.href='register.html'">
        <svg class="app__logout-icon svg-icon" viewBox="0 0 20 20">
            <path d="M20.71,4.04C21.1,3.65 21.1,3 20.71,2.63L18.37,0.29C18,-0.1 17.35,-0.1 16.96,0.29L15,2.25L18.75,6M17.75,7L14,3.25L4,13.25V17H7.75L17.75,7Z"></path>
        </svg>
    </button> -->
    <button class="register" title="Register" onclick="window.location.href='import.html'">
        <svg class="app__logout-icon svg-icon" viewBox="0 0 20 20">
            <path d="M20.71,4.04C21.1,3.65 21.1,3 20.71,2.63L18.37,0.29C18,-0.1 17.35,-0.1 16.96,0.29L15,2.25L18.75,6M17.75,7L14,3.25L4,13.25V17H7.75L17.75,7Z"></path>
        </svg>
    </button>
</div>
</body>
<script>
    var mysql = require('mysql');
    var fs = require("fs");
    var {remote} =require('electron');
    var config = require("./db-config");
    let target_field = new Array();
    let condition_field = new Array();
    let query_items;
    let query_sql;
        

    function el(selector) {
        return document.getElementById(selector);
    }

    function get_item(id) {
        
        const radio = document.getElementsByName(id);
        let type;

        for (i=0; i<radio.length; i++) {
            if(radio[i].checked) {
                type = radio[i].value;
                break;
            }
        }
        
        if(type=='condition'&&document.getElementById(id).value=='') {
            type = 'none';
        }

        return {
            'type': type,
            'content': document.getElementById(id).value
        };
    }
    
    function get_query() {
        let items = {
            'src_lang': get_item('src_lang'),
            'trg_lang': get_item('trg_lang'),
            'date_from': get_item('date_from'),
            'date_to': get_item('date_to'),
            'uploader': get_item('uploader'),
            'src_text': get_item('src_text'),
            'trg_text': get_item('trg_text'),
        }
        return items;
    }

    function check_query(query) {
        // date_from/to cannot be target and date_from must be earlier than date_to
        function tab(date1,date2){
            var oDate1 = new Date(date1);
            var oDate2 = new Date(date2);
            return oDate1.getTime() > oDate2.getTime();
        }

        if(query['date_from'].type=='target' || query['date_to'].type=='target') {
            remote.dialog.showMessageBox({
                    type:'info',
                    title: 'Notice',
                    message: 'Date cannot be chosen as target!',
                    buttons:['ok']
                });
            return false;
        }
        
        const data_from = query['date_from'].content;
        const data_to = query['date_to'].content;
        if(data_from!='' && data_to!='') {
            if(tab(data_from, data_to)) {
                remote.dialog.showMessageBox({
                    type:'info',
                    title: 'Notice',
                    message: 'Date From must be earlier than Date To!',
                    buttons:['ok']
                });
                return false;
            }
        }

        // at least one target 
        let count = 0;
        Object.keys(query).forEach(function(key) {
            if(query[key]['type']=='target') {
                count += 1;
            }
        });
        if(count==0) {
            remote.dialog.showMessageBox({
                    type:'info',
                    title: 'Notice',
                    message: "There must be one target at least!",
                    buttons:['ok']
                });
            return false;
        }

        return true;
    }

    el('action-btn').addEventListener('click', function () {
        // Get the mysql service

        query_items = get_query();
        console.log(query_items);
        const flag = check_query(query_items);
        if (!flag) {
            console.log(flag);
            return;
        }

        target_field = []
        condition_field = []
        Object.keys(query_items).forEach(function(key) {
            if(query_items[key]['type']=='target') {
                target_field.push(key);
            } else if (query_items[key]['type']=='condition') {
                if(key!='date_from'&&key!='date_to') {
                    condition_field.push(key);
                }
            }
        });

        getFirstTenRows(function (rows) {
            var html = '';

            rows.forEach(function (row) {
                html += '<tr>';
                target_field.forEach(function (item) {
                    html += '<td>';
                    html += row[item];
                    html += '</td>';
                });
                html += '</tr>';
            });

            var head = '';
            head += '<tr>';
            target_field.forEach(function (item) {
                head += '<th scope="col">';
                head += item.toUpperCase();
                head += '</th>';
            });
            
            document.querySelector('#table > tbody').innerHTML = html;
            document.querySelector('#table > thead').innerHTML = head;
            // document.querySelector('#table > tfoot').innerHTML = '<tr><td colspan="3">Last joined 10 users are listed here.</td> </tr>';
            
            el('export').style.display='inline';
        });
    }, false);

    function getFirstTenRows(callback) {

        console.log('successfully connect!');
        
        // construct a query
        let $query = 'SELECT ';
        target_field.forEach(function (item) {
            $query += item + ', ';
        });
        $query = $query.substring(0, $query.lastIndexOf(','));
        $query += ' FROM CORPUS '
        if (condition_field.length!=0) {
            $query += 'WHERE ';
            condition_field.forEach(function (item) {
                $query += `${item}="${query_items[item].content}" and `;
            });
        }
        if(query_items['date_from'].type == 'condition') {
            if($query.lastIndexOf('WHERE')==-1) {
                $query += 'WHERE ';
            }
            $query += `date>="${query_items['date_from'].content}" and `;
        }
        if(query_items['date_to'].type == 'condition') {
            if($query.lastIndexOf('WHERE')==-1) {
                $query += 'WHERE ';
            }
            $query += `date<="${query_items['date_to'].content}" and `;
        }

        if($query.lastIndexOf('and')!=-1) {
            $query = $query.substring(0, $query.lastIndexOf('and'));
        }

        console.log(`query: ${$query}`);
        
        // 记录到全局query_sql中，方便export使用
        query_sql = $query;

        ask_mysql($query + 'LIMIT 10', callback);
    }

    function ask_mysql($query, callback) {

        // Add the credentials to access your database
        var connection = mysql.createConnection(config.db);

        // connect to mysql
        connection.connect(function (err) {
            // in case of error
            if (err) {
                console.log(err.code);
                console.log(err.fatal);
            }
        });

        connection.query($query, function (err, rows, fields) {
            if (err) {
                console.log("An error ocurred performing the query.");
                console.log(err);
                return;
            }
            if (typeof(callback) != "undefined") {
                callback(rows);
            }

            console.log("Query succesfully executed");
        });

        // Close the connection
        connection.end(function () {
            // The connection has been closed
        });
    }

    function Export() {
        const save_path = remote.dialog.showSaveDialog({
            "defaultPath": "result.xls"
            }
        );
        console.log(`export path: ${save_path}`);
        if (typeof(save_path) == "undefined") {
            return;
        }

        // 无法导出文件问题有两个：
        // 1. mysql参数设置问题，可以参考：
        //      https://blog.csdn.net/fdipzone/article/details/78634992
        //      https://blog.csdn.net/weixin_41790755/article/details/83021201
        //      https://blog.csdn.net/qq_42142315/article/details/84973970
        // 2. 权限问题，直接 sudo chmod -R 777 .
        // $query += 'into outfile "/Users/bytedance/Desktop/test.xls";';
        // $query += 'into outfile "/Users/bytedance/Desktop/test.xls" CHARACTER SET GBK;'; //有中文的时候最好指定GBK
        let $query = query_sql;
        $query += `into outfile "${save_path}" CHARACTER SET GBK;`;

        // 如果能够来到这一步 如果文件已经存在 用户一定是点了overrite了
        if (fs.existsSync(save_path)) {
            fs.unlinkSync(save_path);
            console.log('overrite the file');
        }
        
        ask_mysql($query);
    }
</script>
</html>
